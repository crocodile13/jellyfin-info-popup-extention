name: Release — Build, Pack & Publish (Manuel)

# =============================================================================
#  CE WORKFLOW EST MANUEL UNIQUEMENT (workflow_dispatch).
#
#  POURQUOI pas de déclenchement automatique sur les tags :
#    Le workflow `make release-*` pousse un tag, crée la GitHub Release et
#    uploade le ZIP local en local. Si ce workflow se déclenche sur le même
#    tag, il recompile le plugin dans un environnement différent (ubuntu-latest
#    runner ≠ machine locale) et écrase le ZIP avec un binaire différent.
#    Résultat : le checksum dans manifest.json ne correspond plus au ZIP servi
#    par GitHub → Jellyfin refuse l'installation.
#
#  QUAND utiliser ce workflow :
#    - En dernier recours si la release locale a échoué
#    - Pour vérifier que le code compile correctement en CI
#    - JAMAIS en même temps qu'un `make release-*` local sur le même tag
#
#  FLOW NORMAL : utiliser `make release-patch / release-minor / release-major`
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag de version existant (ex: v1.2.3.0) — le tag doit déjà exister'
        required: true

jobs:
  release:
    name: Package & Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}
          fetch-depth: 0

      - name: Déterminer la version
        id: version
        run: |
          TAG="${{ github.event.inputs.tag }}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "zip_name=infopopup_${VERSION}.zip" >> "$GITHUB_OUTPUT"
          echo "Version : $VERSION"

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore Jellyfin.Plugin.InfoPopup.sln

      - name: Build Release
        run: dotnet build Jellyfin.Plugin.InfoPopup.sln --configuration Release --no-restore

      - name: Publish
        run: |
          dotnet publish \
            Jellyfin.Plugin.InfoPopup/Jellyfin.Plugin.InfoPopup.csproj \
            --configuration Release \
            --output ./publish \
            --no-build

      - name: Créer le ZIP
        id: zip
        run: |
          mkdir -p dist
          cd publish
          zip -j ../dist/${{ steps.version.outputs.zip_name }} Jellyfin.Plugin.InfoPopup.dll
          cd ..
          CHECKSUM=$(md5sum dist/${{ steps.version.outputs.zip_name }} | awk '{print $1}')
          echo "checksum=$CHECKSUM" >> "$GITHUB_OUTPUT"
          echo "zip_path=dist/${{ steps.version.outputs.zip_name }}" >> "$GITHUB_OUTPUT"
          echo "Checksum MD5 : $CHECKSUM"

      - name: Extraire le changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          NOTES=$(awk \
            "BEGIN{found=0}
             /^## \[?v?${VERSION//./\\.}\]?/{ found=1; next }
             /^## / && found { exit }
             found { print }" \
            CHANGELOG.md | sed '/^[[:space:]]*$/d' | head -30)
          if [ -z "$NOTES" ]; then
            NOTES="Release v${VERSION}"
          fi
          {
            echo "notes<<ENDOFNOTES"
            echo "$NOTES"
            echo "ENDOFNOTES"
          } >> "$GITHUB_OUTPUT"

      - name: Uploader le ZIP sur la release existante
        # Note : utilise --clobber pour remplacer le ZIP si la release existe déjà.
        # Après cet upload, relancer `make manifest-update` localement pour
        # recalculer le MD5 depuis GitHub et mettre à jour manifest.json.
        run: |
          gh release upload "${{ steps.version.outputs.tag }}" \
            "${{ steps.zip.outputs.zip_path }}#${{ steps.version.outputs.zip_name }}" \
            --repo "${{ github.repository }}" \
            --clobber
          echo "✓ ZIP uploadé. MD5 CI : ${{ steps.zip.outputs.checksum }}"
          echo ""
          echo "⚠ IMPORTANT : si vous utilisez ce workflow manuellement,"
          echo "  relancez ensuite 'make manifest-update && make push' en local"
          echo "  pour mettre à jour le checksum dans manifest.json."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
